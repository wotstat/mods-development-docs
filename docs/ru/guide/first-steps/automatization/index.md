# Автоматизация сборки модов

Автоматизация сборки позволяет избавить вас от рутинных задач и значительно упростить процесс дистрибуции модов.

Для автоматизации следует создать репозиторий с исходным кодом и настроить CI/CD пайплайн, которые будет компилировать вашу модификацию при установке тега в системе контроля версий.

## Необходимые инструменты
- Настроенное окружение для `Python` модов (см. [инструкцию по настройке окружения для Python](../environment/python/))
- [Git](https://git-scm.com/) - система контроля версий, с помощью которой будет загружен исходный код игры.

Весь процесс полностью бесплатен.

## Создание репозитория системы контроля версий

В качестве хранилища исходного кода можно использовать любой из популярных сервисов, однако наиболее распространённым является [GitHub](https://
github.com/). На его примере рассмотрим процесс автоматизации сборки.

Если у вас ещё нет аккаунта на GitHub, создайте его.

GitHub позволяет бесплатно создавать как публичные, так и приватные репозитории с исходным кодом и отслеживанием изменений.

1. На главной странице GitHub нажмите на свой профиль и выберите `Repositories`.
   ::: details Меню профиля
   ![Repositories](./assets/go-to-repos.png){width=400}
   :::
2. Нажмите на кнопку `New` для создания нового репозитория.
   - Придумайте название репозитория, например `my-first-mod`.
   - Выберите `Public` или `Private` в зависимости от того, хотите ли вы, чтобы ваш мод был доступен всем или только вам.
   - Не меняйте остальные настройки и нажмите на кнопку `Create repository`.

### Связывание локального проекта с репозиторием
После создания репозитория вам будет показана страница с инструкцией по связыванию локального проекта с удалённым репозиторием. Но перед этим необходимо подготовить локальный проект.

В корне вашего проекта создайте файл `.gitignore` со следующим содержимым:
``` [.gitignore]
*.pyc
*.wotmod
*.mtmod

wot-src/
as3/bin
```
Этот файл указывает системе контроля версий Git, какие файлы и папки не нужно отслеживать. В данном случае мы исключаем скомпилированные файлы, архивы модов и папки с исходным кодом игры и скомпилированными `AS3` файлами.

После этого откройте терминал в VSCode (`` Ctrl+` `` или `Terminal -> New Terminal`) и выполните команды, чтобы связать ваш локальный проект с удалённым репозиторием.

Инициализируйте локальный репозиторий:
```powershell
git init
```

Задайте имя основной ветки:
```powershell
git branch -M main 
```

Привяжите удалённый репозиторий, заменив `<your-username>` и `<your-repo>` на ваши значения:
```powershell
git remote add origin https://github.com/<your-username>/<your-repo>.git
```
> Найти ссылку на репозиторий вы можете на странице этого репозитория, она будет расположена в каждом из приветственных блоков, и будет выглядеть примерно так: `https://github.com/SoprachevAK/my-first-mod.git`


### Отправка первого коммита
Коммитом (commit) в системе контроля версий Git называется зафиксированное изменение в проекте. Коммиты позволяют отслеживать историю изменений, возвращаться к предыдущим версиям и работать над проектом совместно с другими людьми.

Чтобы отправить первый коммит, откройте в VSCode вкладку `Source Control` и в подразделе `Changes` у вас будут отображаться все файлы, которые были изменены или добавлены в вашем проекте.
![Source Control](./assets/source-control.png){width=400}

Наведите курсор на `Changes` и нажмите на иконку `+`, чтобы отметить все файлы как готовые к коммиту (Staged Changes). После этого введите сообщение коммита в поле ввода сверху, например `Initial commit`, и нажмите на кнопку `Commit`.
![Initial commit](./assets/initial-commit.png){width=400}

::: details Если вылезла ошибка
Если вы раньше не настраивали своё имя пользователя и email в Git, то при попытке сделать коммит у вас может появиться ошибка. 

![Name and email error](./assets/name-error.png){width=400}


В этом случае откройте терминал в VSCode (`` Ctrl+` `` или `Terminal -> New Terminal`) и выполните следующие команды, заменив `<your-name>` и `<your-email>` на ваши значения:
```powershell
git config --global user.name "<your-name>"
git config --global user.email "<your-email>"
```
Это установит ваше имя и email для всех будущих коммитов. После этого повторите попытку сделать коммит.

Если вы не хотите раскрывать свой email, вы можете использовать служебный адрес GitHub, перейдите в [Настройки профиля GitHub -> Emails](https://github.com/settings/emails), включите опцию `Keep my email addresses private` и используйте предоставленный там адрес вида `<your-username>@users.noreply.github.com`.
:::

После того, как вы сделали коммит, вам нужно отправить его в удалённый репозиторий. Для этого в том же месте нажмите на кнопку `Publish branch`. 

> Если это ваш первый пуш в репозиторий, вам может понадобиться авторизоваться через GitHub аккаунт.

Готово! Вы успешно отправили первый коммит в удалённый репозиторий. Теперь вы можете обновить страницу вашего репозитория на GitHub и увидеть там ваши файлы.
![GitHub repo](./assets/gh-repo.png)

## Настройка автоматической сборки
Автоматизация процессов в GitHub осуществляется с помощью GitHub Actions. Это встроенный инструмент, который предоставляет вам виртуальную машину для выполнения скриптов. На этой виртуальной машине мы и будет запускать наш `build` скрипт, а результат его работы (архив с модом) будет загружаться в релизы репозитория.

Для настройки автоматической сборки создайте в корне вашего проекта папку `.github/workflows`, cкачайте [файл release.yaml](/download/mod-build/release.yaml){target=_blank download} и поместите его в эту папку.

Так как на виртуальной машине GitHub Actions запускается `Ubuntu`, а наш скрипт сборки написан для `Windows`, нам нужно создать аналогичный `build.sh` скрипт, который будет работать на `Linux`.

::: tip TODO
Инструкция ещё не закончена
:::