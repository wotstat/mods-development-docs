# Автоматизация сборки модов

Автоматизация сборки позволяет избавить вас от рутинных задач и значительно упростить процесс дистрибуции модов.

Для автоматизации следует создать репозиторий с исходным кодом и настроить CI/CD пайплайн, которые будет компилировать вашу модификацию при установке тега в системе контроля версий.

## Необходимые инструменты
- Настроенное окружение для `Python` модов (см. [инструкцию по настройке окружения для Python](../environment/python/))
- [Git](https://git-scm.com/) - система контроля версий, с помощью которой будет загружен исходный код игры.

Весь процесс полностью бесплатен.

## Создание репозитория системы контроля версий

В качестве хранилища исходного кода можно использовать любой из популярных сервисов, однако наиболее распространённым является [GitHub](https://
github.com/). На его примере рассмотрим процесс автоматизации сборки.

Если у вас ещё нет аккаунта на GitHub, создайте его.

GitHub позволяет бесплатно создавать как публичные, так и приватные репозитории с исходным кодом и отслеживанием изменений.

1. На главной странице GitHub нажмите на свой профиль и выберите `Repositories`.
::: details Меню профиля
![Repositories](./assets/go-to-repos.png){width=400}
:::
2. Нажмите на кнопку `New` для создания нового репозитория.
  - Придумайте название репозитория, например `my-first-mod`.
  - Выберите `Public` или `Private` в зависимости от того, хотите ли вы, чтобы ваш мод был доступен всем или только вам.
  - Не меняйте остальные настройки и нажмите на кнопку `Create repository`.

### Связывание локального проекта с репозиторием
После создания репозитория вам будет показана страница с инструкцией по связыванию локального проекта с удалённым репозиторием. Но перед этим необходимо подготовить локальный проект.

В корне вашего проекта создайте файл `.gitignore` со следующим содержимым:
``` [.gitignore]
*.pyc
*.wotmod
*.mtmod

wot-src/
as3/bin
```
Этот файл указывает системе контроля версий Git, какие файлы и папки не нужно отслеживать. В данном случае мы исключаем скомпилированные файлы, архивы модов и папки с исходным кодом игры и скомпилированными `AS3` файлами.

После этого откройте терминал в VSCode (`` Ctrl+` `` или `Terminal -> New Terminal`) и выполните команды, чтобы связать ваш локальный проект с удалённым репозиторием.

Инициализируйте локальный репозиторий:
```powershell
git init
```

Задайте имя основной ветки:
```powershell
git branch -M main
```

Привяжите удалённый репозиторий, заменив `<your-username>` и `<your-repo>` на ваши значения:
```powershell
git remote add origin https://github.com/<your-username>/<your-repo>.git
```
> Найти ссылку на репозиторий вы можете на странице этого репозитория, она будет расположена в каждом из приветственных блоков, и будет выглядеть примерно так: `https://github.com/SoprachevAK/my-first-mod.git`


### Отправка первого коммита
Коммитом (commit) в системе контроля версий Git называется зафиксированное изменение в проекте. Коммиты позволяют отслеживать историю изменений, возвращаться к предыдущим версиям и работать над проектом совместно с другими людьми.

Чтобы отправить первый коммит, откройте в VSCode вкладку `Source Control` и в подразделе `Changes` у вас будут отображаться все файлы, которые были изменены или добавлены в вашем проекте.
![Source Control](./assets/source-control.png){width=400}

Наведите курсор на `Changes` и нажмите на иконку `+`, чтобы отметить все файлы как готовые к коммиту (Staged Changes). После этого введите сообщение коммита в поле ввода сверху, например `Initial commit`, и нажмите на кнопку `Commit`.
![Initial commit](./assets/initial-commit.png){width=400}

::: details Если вылезла ошибка
Если вы раньше не настраивали своё имя пользователя и email в Git, то при попытке сделать коммит у вас может появиться ошибка.

![Name and email error](./assets/name-error.png){width=400}


В этом случае откройте терминал в VSCode (`` Ctrl+` `` или `Terminal -> New Terminal`) и выполните следующие команды, заменив `<your-name>` и `<your-email>` на ваши значения:
```powershell
git config --global user.name "<your-name>"
git config --global user.email "<your-email>"
```
Это установит ваше имя и email для всех будущих коммитов. После этого повторите попытку сделать коммит.

Если вы не хотите раскрывать свой email, вы можете использовать служебный адрес GitHub, перейдите в [Настройки профиля GitHub -> Emails](https://github.com/settings/emails), включите опцию `Keep my email addresses private` и используйте предоставленный там адрес вида `<your-username>@users.noreply.github.com`.
:::

После того, как вы сделали коммит, вам нужно отправить его в удалённый репозиторий. Для этого в том же месте нажмите на кнопку `Publish branch`.

> Если это ваш первый пуш в репозиторий, вам может понадобиться авторизоваться через GitHub аккаунт.

Готово! Вы успешно отправили первый коммит в удалённый репозиторий. Теперь вы можете обновить страницу вашего репозитория на GitHub и увидеть там ваши файлы.
![GitHub repo](./assets/gh-repo.png)

## Настройка автоматической сборки
Автоматизация процессов в GitHub осуществляется с помощью GitHub Actions. Это встроенный инструмент, который предоставляет вам виртуальную машину для выполнения скриптов. На этой виртуальной машине мы и будет запускать наш `build` скрипт, а результат его работы (архив с модом) будет загружаться в релизы репозитория.

Для настройки автоматической сборки создайте в корне вашего проекта папку `.github/workflows`, cкачайте [файл release.yaml](/download/mod-build/release.yaml){target=_blank download} и поместите его в эту папку.

Так как на виртуальной машине GitHub Actions запускается `Ubuntu`, а наш скрипт сборки написан для `Windows`, нам нужно создать аналогичный `build.sh` скрипт, который будет работать на `Linux`.

Скачайте [файл build.sh](/download/mod-build/build.sh){target=_blank download} и поместите его в корень вашего проекта (рядом с `build.bat`).
На первых строках есть раздел с настройками, которые вам нужно изменить под ваш мод:
```bash [build.sh]:line-numbers=3
# Настройки
MOD_NAME="my.first-mod"
MOD_ENTRY=mod_myFirstMod.py
```

### Если у вас есть `AS3` часть
Если в вашем моде есть `AS3` часть, то вам нужно создать `as3/build.sh` скрипт, по аналогии с `build.bat`, который будет собирать `AS3` часть на `Linux`. Если у вас нет `AS3` части, то вы можете пропустить этот шаг.

```sh [as3/build.sh]:line-numbers
mxmlc -load-config+=build-config.xml --output=bin/my.first_mod.HelloWorldWindow.swf src/my/first_mod/HelloWorldWindow.as
```

Строки этого файла должны быть аналогичны тем, что вы используете в `build.bat` для сборки `AS3` части. Если у вас несколько `SWF` файлов, то добавьте соответствующие команды `mxmlc` для каждого из них.

### Отправка изменений в репозиторий
Отправьте изменения в репозиторий:
- На вкладке `Source Control` нажмите на иконку `+`, чтобы отметить все файлы как готовые к коммиту (Staged Changes).
- Введите сообщение коммита в поле ввода сверху, например `Setup CI/CD`, и нажмите на кнопку `Commit`.
- Нажмите на кнопку `Sync Changes`, чтобы отправить изменения в удалённый репозиторий.

![cicd-commit](./assets/cicd-commit.png){width=400}

### Запуск сборки
Чтобы запустить сборку, вам нужно создать тег в системе контроля версий. Тег — это метка, которая указывает на определённый коммит в истории проекта. Тег будет использоваться в качестве версии вашего мода.

1. Откройте терминал в VSCode (`` Ctrl+` `` или `Terminal -> New Terminal`) и выполните команду, заменив `1.0.0` на версию вашего мода:
```powershell
git tag 1.0.0
```
2. Отправьте тег в удалённый репозиторий:
```powershell
git push --tags
```
![tag-push](./assets/tag-push.png){width=400}

::: tip Совет
Если вы вдруг отправили непрафильный тег и хотите его удалить, то выполните команды:
```powershell
git tag -d 1.0.0
git push origin :refs/tags/1.0.0
```
:::


#### Проверка `Actions`
Перейдите на страницу вашего репозитория на GitHub и откройте вкладку `Actions`. Вы увидите, что запустился новый workflow с именем `release`. Нажмите на него, чтобы посмотреть детали сборки.

Дождитесь завершения сборки. Если всё прошло успешно, вы увидите зелёную галочку.
![build-success](./assets/build-success.png)
Если сборка завершилась с ошибкой, вы увидите красный крестик. Нажмите на него, чтобы посмотреть логи и понять, что пошло не так.

#### Информация о релизе
После успешной сборки перейдите на вкладку `Releases` вашего репозитория. Вы увидите новый релиз с версией, соответствующей вашему тегу, и вложением с вашим модом в формате `.mtmod`.
![release](./assets/release.png)

Нажмите на кнопку редактирования релиза (иконка карандаша), чтобы добавить описание к вашему релизу.
![release-info](./assets/release-info.png)

#### Редактирование релиза
Добавьте описание изменений в вашем моде и уберите галочку `This is a pre-release`, если вы хотите, чтобы релиз был виден всем пользователям. После этого нажмите на кнопку `Update release`.
![release-edit](./assets/release-edit.png)

## Результат
Поздравляем! Вы успешно настроили автоматическую сборку вашего мода. Теперь каждый раз, когда вы будете создавать новый тег и отправлять его в репозиторий, будет автоматически запускаться сборка, и результат будет доступен в релизах вашего репозитория.

Другие пользователи смогут скачать актуальную версию вашего мода прямо с GitHub, перейдя на вкладку `Releases` вашего репозитория.

![result](./assets/result.png)
